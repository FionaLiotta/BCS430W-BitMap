let countryColors = {
  "4": {
    countryColorId: "4",
    name: "Afghanistan",
    color: "#FF2200"
  },
  "8": {
    countryColorId: "7",
    name: "Albania",
    color: "#FF3C00"
  },
  "10": {
    countryColorId: "10",
    name: "Antarctica",
    color: "#FF5500"
  },
  "12": {
    countryColorId: "65",
    name: "Algeria",
    color: "#00FF2B"
  },
  "16": {
    countryColorId: "12",
    name: "American Samoa",
    color: "#FF6600"
  },
  "20": {
    countryColorId: "2",
    name: "Andorra",
    color: "#FF1100"
  },
  "24": {
    countryColorId: "9",
    name: "Angola",
    color: "#FF4D00"
  },
  "31": {
    countryColorId: "17",
    name: "Azerbaijan",
    color: "#FF9100"
  },
  "32": {
    countryColorId: "11",
    name: "Argentina",
    color: "#FF5E00"
  },
  "36": {
    countryColorId: "14",
    name: "Australia",
    color: "#FF7700"
  },
  "40": {
    countryColorId: "13",
    name: "Austria",
    color: "#FF6E00"
  },
  "44": {
    countryColorId: "33",
    name: "Bahamas",
    color: "#E6FF00"
  },
  "48": {
    countryColorId: "24",
    name: "Bahrain",
    color: "#FFCC00"
  },
  "50": {
    countryColorId: "20",
    name: "Bangladesh",
    color: "#FFAA00"
  },
  "51": {
    countryColorId: "8",
    name: "Armenia",
    color: "#FF4400"
  },
  "52": {
    countryColorId: "19",
    name: "Barbados",
    color: "#FFA200"
  },
  "56": {
    countryColorId: "21",
    name: "Belgium",
    color: "#FFB300"
  },
  "60": {
    countryColorId: "28",
    name: "Bermuda",
    color: "#FFEE00"
  },
  "64": {
    countryColorId: "34",
    name: "Bhutan",
    color: "#DDFF00"
  },
  "72": {
    countryColorId: "36",
    name: "Botswana",
    color: "#CCFF00"
  },
  "74": {
    countryColorId: "35",
    name: "Bouvet Island",
    color: "#D4FF00"
  },
  "76": {
    countryColorId: "32",
    name: "Brazil",
    color: "#EEFF00"
  },
  "84": {
    countryColorId: "38",
    name: "Belize",
    color: "#BBFF00"
  },
  "86": {
    countryColorId: "112",
    name: "British Indian Ocean Territory",
    color: "#0044FF"
  },
  "90": {
    countryColorId: "200",
    name: "Solomon Islands",
    color: "#FFD480"
  },
  "100": {
    countryColorId: "23",
    name: "Bulgaria",
    color: "#FFC300"
  },
  "108": {
    countryColorId: "25",
    name: "Burundi",
    color: "#FFD500"
  },
  "112": {
    countryColorId: "37",
    name: "Belarus",
    color: "#C3FF00"
  },
  "116": {
    countryColorId: "123",
    name: "Cambodia",
    color: "#1900FF"
  },
  "120": {
    countryColorId: "48",
    name: "Cameroon",
    color: "#66FF00"
  },
  "124": {
    countryColorId: "39",
    name: "Canada",
    color: "#B2FF00"
  },
  "132": {
    countryColorId: "54",
    name: "Cape Verde",
    color: "#33FF00"
  },
  "136": {
    countryColorId: "130",
    name: "Cayman Islands",
    color: "#5500FF"
  },
  "140": {
    countryColorId: "42",
    name: "Central African Republic",
    color: "#99FF00"
  },
  "144": {
    countryColorId: "136",
    name: "Sri Lanka",
    color: "#8800FF"
  },
  "148": {
    countryColorId: "222",
    name: "Chad",
    color: "#CCFF80"
  },
  "152": {
    countryColorId: "47",
    name: "Chile",
    color: "#6EFF00"
  },
  "156": {
    countryColorId: "49",
    name: "China",
    color: "#5EFF00"
  },
  "162": {
    countryColorId: "56",
    name: "Christmas Island",
    color: "#22FF00"
  },
  "166": {
    countryColorId: "40",
    name: "Cocos (Keeling) Islands",
    color: "#AAFF00"
  },
  "170": {
    countryColorId: "50",
    name: "Colombia",
    color: "#55FF00"
  },
  "174": {
    countryColorId: "125",
    name: "Comoros",
    color: "#2A00FF"
  },
  "175": {
    countryColorId: "255",
    name: "Mayotte",
    color: "#80FFBF"
  },
  "184": {
    countryColorId: "46",
    name: "Cook Islands",
    color: "#77FF00"
  },
  "188": {
    countryColorId: "52",
    name: "Costa Rica",
    color: "#44FF00"
  },
  "191": {
    countryColorId: "103",
    name: "Croatia",
    color: "#0091FF"
  },
  "192": {
    countryColorId: "53",
    name: "Cuba",
    color: "#3BFF00"
  },
  "196": {
    countryColorId: "57",
    name: "Cyprus",
    color: "#1AFF00"
  },
  "204": {
    countryColorId: "26",
    name: "Benin",
    color: "#FFDD00"
  },
  "208": {
    countryColorId: "62",
    name: "Denmark",
    color: "#00FF11"
  },
  "212": {
    countryColorId: "63",
    name: "Dominica",
    color: "#00FF19"
  },
  "214": {
    countryColorId: "64",
    name: "Dominican Republic",
    color: "#00FF22"
  },
  "218": {
    countryColorId: "67",
    name: "Ecuador",
    color: "#00FF3C"
  },
  "222": {
    countryColorId: "216",
    name: "El Salvador",
    color: "#E5FF80"
  },
  "226": {
    countryColorId: "93",
    name: "Equatorial Guinea",
    color: "#00E5FF"
  },
  "231": {
    countryColorId: "73",
    name: "Ethiopia",
    color: "#00FF6F"
  },
  "232": {
    countryColorId: "71",
    name: "Eritrea",
    color: "#00FF5E"
  },
  "233": {
    countryColorId: "68",
    name: "Estonia",
    color: "#00FF44"
  },
  "234": {
    countryColorId: "79",
    name: "Faroe Islands",
    color: "#00FFA2"
  },
  "242": {
    countryColorId: "76",
    name: "Fiji",
    color: "#00FF88"
  },
  "246": {
    countryColorId: "75",
    name: "Finland",
    color: "#00FF80"
  },
  "248": {
    countryColorId: "16",
    name: "Åland Islands",
    color: "#FF8800"
  },
  "250": {
    countryColorId: "80",
    name: "France",
    color: "#00FFAA"
  },
  "254": {
    countryColorId: "85",
    name: "French Guiana",
    color: "#00FFD5"
  },
  "258": {
    countryColorId: "181",
    name: "French Polynesia",
    color: "#FF0900"
  },
  "260": {
    countryColorId: "223",
    name: "French Southern Territories",
    color: "#C8FF80"
  },
  "262": {
    countryColorId: "61",
    name: "Djibouti",
    color: "#00FF09"
  },
  "266": {
    countryColorId: "81",
    name: "Gabon",
    color: "#00FFB3"
  },
  "268": {
    countryColorId: "84",
    name: "Georgia",
    color: "#00FFCC"
  },
  "270": {
    countryColorId: "90",
    name: "Gambia",
    color: "#00FFFF"
  },
  "276": {
    countryColorId: "59",
    name: "Germany",
    color: "#08FF00"
  },
  "288": {
    countryColorId: "87",
    name: "Ghana",
    color: "#00FFE6"
  },
  "292": {
    countryColorId: "88",
    name: "Gibraltar",
    color: "#00FFEE"
  },
  "296": {
    countryColorId: "124",
    name: "Kiribati",
    color: "#2200FF"
  },
  "300": {
    countryColorId: "94",
    name: "Greece",
    color: "#00DDFF"
  },
  "304": {
    countryColorId: "89",
    name: "Greenland",
    color: "#00FFF7"
  },
  "308": {
    countryColorId: "83",
    name: "Grenada",
    color: "#00FFC4"
  },
  "312": {
    countryColorId: "92",
    name: "Guadeloupe",
    color: "#00EEFF"
  },
  "316": {
    countryColorId: "97",
    name: "Guam",
    color: "#00C3FF"
  },
  "320": {
    countryColorId: "96",
    name: "Guatemala",
    color: "#00CCFF"
  },
  "324": {
    countryColorId: "91",
    name: "Guinea",
    color: "#00F6FF"
  },
  "328": {
    countryColorId: "99",
    name: "Guyana",
    color: "#00B2FF"
  },
  "332": {
    countryColorId: "104",
    name: "Haiti",
    color: "#0088FF"
  },
  "340": {
    countryColorId: "102",
    name: "Honduras",
    color: "#0099FF"
  },
  "348": {
    countryColorId: "105",
    name: "Hungary",
    color: "#007FFF"
  },
  "352": {
    countryColorId: "115",
    name: "Iceland",
    color: "#002BFF"
  },
  "356": {
    countryColorId: "111",
    name: "India",
    color: "#004CFF"
  },
  "360": {
    countryColorId: "107",
    name: "Indonesia",
    color: "#006EFF"
  },
  "368": {
    countryColorId: "113",
    name: "Iraq",
    color: "#003BFF"
  },
  "372": {
    countryColorId: "108",
    name: "Ireland",
    color: "#0066FF"
  },
  "376": {
    countryColorId: "109",
    name: "Israel",
    color: "#005EFF"
  },
  "380": {
    countryColorId: "116",
    name: "Italy",
    color: "#0022FF"
  },
  "388": {
    countryColorId: "118",
    name: "Jamaica",
    color: "#0011FF"
  },
  "392": {
    countryColorId: "120",
    name: "Japan",
    color: "#0000FF"
  },
  "398": {
    countryColorId: "131",
    name: "Kazakhstan",
    color: "#5E00FF"
  },
  "400": {
    countryColorId: "119",
    name: "Jordan",
    color: "#0008FF"
  },
  "404": {
    countryColorId: "121",
    name: "Kenya",
    color: "#0800FF"
  },
  "414": {
    countryColorId: "129",
    name: "Kuwait",
    color: "#4D00FF"
  },
  "417": {
    countryColorId: "122",
    name: "Kyrgyzstan",
    color: "#1100FF"
  },
  "422": {
    countryColorId: "133",
    name: "Lebanon",
    color: "#6E00FF"
  },
  "426": {
    countryColorId: "138",
    name: "Lesotho",
    color: "#9900FF"
  },
  "428": {
    countryColorId: "141",
    name: "Latvia",
    color: "#B300FF"
  },
  "430": {
    countryColorId: "137",
    name: "Liberia",
    color: "#9000FF"
  },
  "434": {
    countryColorId: "142",
    name: "Libya",
    color: "#BB00FF"
  },
  "438": {
    countryColorId: "135",
    name: "Liechtenstein",
    color: "#7F00FF"
  },
  "440": {
    countryColorId: "139",
    name: "Lithuania",
    color: "#A200FF"
  },
  "442": {
    countryColorId: "140",
    name: "Luxembourg",
    color: "#AA00FF"
  },
  "450": {
    countryColorId: "148",
    name: "Madagascar",
    color: "#EE00FF"
  },
  "454": {
    countryColorId: "162",
    name: "Malawi",
    color: "#FF0099"
  },
  "458": {
    countryColorId: "164",
    name: "Malaysia",
    color: "#FF0088"
  },
  "462": {
    countryColorId: "161",
    name: "Maldives",
    color: "#FF00A1"
  },
  "466": {
    countryColorId: "151",
    name: "Mali",
    color: "#FF00F6"
  },
  "470": {
    countryColorId: "159",
    name: "Malta",
    color: "#FF00B2"
  },
  "474": {
    countryColorId: "156",
    name: "Martinique",
    color: "#FF00CC"
  },
  "478": {
    countryColorId: "157",
    name: "Mauritania",
    color: "#FF00C3"
  },
  "480": {
    countryColorId: "160",
    name: "Mauritius",
    color: "#FF00AA"
  },
  "484": {
    countryColorId: "163",
    name: "Mexico",
    color: "#FF0091"
  },
  "492": {
    countryColorId: "144",
    name: "Monaco",
    color: "#CC00FF"
  },
  "496": {
    countryColorId: "153",
    name: "Mongolia",
    color: "#FF00E6"
  },
  "499": {
    countryColorId: "146",
    name: "Montenegro",
    color: "#DD00FF"
  },
  "500": {
    countryColorId: "158",
    name: "Montserrat",
    color: "#FF00BB"
  },
  "504": {
    countryColorId: "143",
    name: "Morocco",
    color: "#C300FF"
  },
  "508": {
    countryColorId: "165",
    name: "Mozambique",
    color: "#FF0080"
  },
  "512": {
    countryColorId: "178",
    name: "Oman",
    color: "#FF0011"
  },
  "516": {
    countryColorId: "166",
    name: "Namibia",
    color: "#FF0077"
  },
  "520": {
    countryColorId: "175",
    name: "Nauru",
    color: "#FF002B"
  },
  "524": {
    countryColorId: "174",
    name: "Nepal",
    color: "#FF0033"
  },
  "528": {
    countryColorId: "172",
    name: "Netherlands",
    color: "#FF0044"
  },
  "531": {
    countryColorId: "55",
    name: "Curaçao",
    color: "#2BFF00"
  },
  "533": {
    countryColorId: "15",
    name: "Aruba",
    color: "#FF8000"
  },
  "540": {
    countryColorId: "167",
    name: "New Caledonia",
    color: "#FF006E"
  },
  "548": {
    countryColorId: "250",
    name: "Vanuatu",
    color: "#80FFAA"
  },
  "554": {
    countryColorId: "177",
    name: "New Zealand",
    color: "#FF001A"
  },
  "558": {
    countryColorId: "171",
    name: "Nicaragua",
    color: "#FF004C"
  },
  "562": {
    countryColorId: "168",
    name: "Niger",
    color: "#FF0066"
  },
  "566": {
    countryColorId: "170",
    name: "Nigeria",
    color: "#FF0055"
  },
  "570": {
    countryColorId: "176",
    name: "Niue",
    color: "#FF0022"
  },
  "574": {
    countryColorId: "169",
    name: "Norfolk Island",
    color: "#FF005D"
  },
  "578": {
    countryColorId: "173",
    name: "Norway",
    color: "#FF003B"
  },
  "580": {
    countryColorId: "155",
    name: "Northern Mariana Islands",
    color: "#FF00D4"
  },
  "584": {
    countryColorId: "149",
    name: "Marshall Islands",
    color: "#F600FF"
  },
  "585": {
    countryColorId: "191",
    name: "Palau",
    color: "#FFAE80"
  },
  "586": {
    countryColorId: "184",
    name: "Pakistan",
    color: "#FF9180"
  },
  "591": {
    countryColorId: "179",
    name: "Panama",
    color: "#FF0008"
  },
  "598": {
    countryColorId: "182",
    name: "Papua New Guinea",
    color: "#FF8880"
  },
  "600": {
    countryColorId: "192",
    name: "Paraguay",
    color: "#FFB380"
  },
  "604": {
    countryColorId: "180",
    name: "Peru",
    color: "#FF0000"
  },
  "608": {
    countryColorId: "183",
    name: "Philippines",
    color: "#FF8C80"
  },
  "616": {
    countryColorId: "185",
    name: "Poland",
    color: "#FF9580"
  },
  "620": {
    countryColorId: "190",
    name: "Portugal",
    color: "#FFAA80"
  },
  "624": {
    countryColorId: "98",
    name: "Guinea-Bissau",
    color: "#00BBFF"
  },
  "626": {
    countryColorId: "228",
    name: "Timor-Leste",
    color: "#B3FF80"
  },
  "630": {
    countryColorId: "188",
    name: "Puerto Rico",
    color: "#FFA280"
  },
  "634": {
    countryColorId: "193",
    name: "Qatar",
    color: "#FFB780"
  },
  "638": {
    countryColorId: "194",
    name: "Réunion",
    color: "#FFBB80"
  },
  "642": {
    countryColorId: "195",
    name: "Romania",
    color: "#FFBF80"
  },
  "643": {
    countryColorId: "197",
    name: "Russia",
    color: "#FFC880"
  },
  "646": {
    countryColorId: "198",
    name: "Rwanda",
    color: "#FFCC80"
  },
  "660": {
    countryColorId: "6",
    name: "Anguilla",
    color: "#FF3300"
  },
  "674": {
    countryColorId: "210",
    name: "San Marino",
    color: "#FFFF80"
  },
  "682": {
    countryColorId: "199",
    name: "Saudi Arabia",
    color: "#FFD080"
  },
  "686": {
    countryColorId: "211",
    name: "Senegal",
    color: "#FBFF80"
  },
  "688": {
    countryColorId: "196",
    name: "Serbia",
    color: "#FFC380"
  },
  "690": {
    countryColorId: "201",
    name: "Seychelles",
    color: "#FFD980"
  },
  "694": {
    countryColorId: "209",
    name: "Sierra Leone",
    color: "#FFFB80"
  },
  "702": {
    countryColorId: "204",
    name: "Singapore",
    color: "#FFE680"
  },
  "703": {
    countryColorId: "208",
    name: "Slovakia",
    color: "#FFF780"
  },
  "705": {
    countryColorId: "206",
    name: "Slovenia",
    color: "#FFEE80"
  },
  "706": {
    countryColorId: "212",
    name: "Somalia",
    color: "#F7FF80"
  },
  "710": {
    countryColorId: "257",
    name: "South Africa",
    color: "#80FFC4"
  },
  "716": {
    countryColorId: "259",
    name: "Zimbabwe",
    color: "#80FFCC"
  },
  "724": {
    countryColorId: "72",
    name: "Spain",
    color: "#00FF66"
  },
  "728": {
    countryColorId: "214",
    name: "South Sudan",
    color: "#EEFF80"
  },
  "729": {
    countryColorId: "202",
    name: "Sudan",
    color: "#FFDD80"
  },
  "732": {
    countryColorId: "70",
    name: "Western Sahara",
    color: "#00FF55"
  },
  "740": {
    countryColorId: "213",
    name: "Suriname",
    color: "#F2FF80"
  },
  "748": {
    countryColorId: "219",
    name: "Swaziland",
    color: "#D9FF80"
  },
  "752": {
    countryColorId: "203",
    name: "Sweden",
    color: "#FFE180"
  },
  "756": {
    countryColorId: "44",
    name: "Switzerland",
    color: "#88FF00"
  },
  "762": {
    countryColorId: "226",
    name: "Tajikistan",
    color: "#BBFF80"
  },
  "764": {
    countryColorId: "225",
    name: "Thailand",
    color: "#BFFF80"
  },
  "768": {
    countryColorId: "224",
    name: "Togo",
    color: "#C4FF80"
  },
  "772": {
    countryColorId: "227",
    name: "Tokelau",
    color: "#B7FF80"
  },
  "776": {
    countryColorId: "231",
    name: "Tonga",
    color: "#A6FF80"
  },
  "784": {
    countryColorId: "3",
    name: "United Arab Emirates",
    color: "#FF1A00"
  },
  "788": {
    countryColorId: "230",
    name: "Tunisia",
    color: "#AAFF80"
  },
  "792": {
    countryColorId: "232",
    name: "Turkey",
    color: "#A1FF80"
  },
  "795": {
    countryColorId: "229",
    name: "Turkmenistan",
    color: "#AEFF80"
  },
  "798": {
    countryColorId: "234",
    name: "Tuvalu",
    color: "#99FF80"
  },
  "800": {
    countryColorId: "238",
    name: "Uganda",
    color: "#88FF80"
  },
  "804": {
    countryColorId: "237",
    name: "Ukraine",
    color: "#8CFF80"
  },
  "818": {
    countryColorId: "69",
    name: "Egypt",
    color: "#00FF4D"
  },
  "826": {
    countryColorId: "82",
    name: "United Kingdom",
    color: "#00FFBB"
  },
  "831": {
    countryColorId: "86",
    name: "Guernsey",
    color: "#00FFDD"
  },
  "832": {
    countryColorId: "117",
    name: "Jersey",
    color: "#0019FF"
  },
  "833": {
    countryColorId: "110",
    name: "Isle of Man",
    color: "#0055FF"
  },
  "840": {
    countryColorId: "241",
    name: "United States",
    color: "#80FF84"
  },
  "854": {
    countryColorId: "22",
    name: "Burkina Faso",
    color: "#FFBB00"
  },
  "858": {
    countryColorId: "242",
    name: "Uruguay",
    color: "#80FF88"
  },
  "860": {
    countryColorId: "243",
    name: "Uzbekistan",
    color: "#80FF8C"
  },
  "882": {
    countryColorId: "252",
    name: "Samoa",
    color: "#80FFB3"
  },
  "887": {
    countryColorId: "254",
    name: "Yemen",
    color: "#80FFBB"
  },
  "894": {
    countryColorId: "257",
    name: "Zambia",
    color: "#80FFC8"
  },
  "-2": {
    countryColorId: "253",
    name: "Kosovo",
    color: "#80FFB7"
  }
};

//
// Configuration
//

var twitch = window.Twitch.ext;

window.addEventListener("resize", scale);

//
// Variables
//


const mapType = document.getElementById("mapType").getAttribute("data-map-type");

// ms to wait after dragging before auto-rotating
var rotationDelay = 3000;
// scale of the globe (not the canvas element)
var scaleFactor = mapType === "flat" ? 0.5 : 0.6;
// autorotation speed
var degPerSec = 6;
// start angles
var angles = { x: -20, y: 40, z: 0 };
// colors
var colorWater = "#6441a5";
var colorLand = "black";
var colorGraticule = "white";
var current = d3.select("#current");
var canvas = d3.select("#overlayMap");
var context = canvas.node().getContext("2d");
var water = { type: "Sphere" };
var projection = mapType === "flat" ? d3.geoMercator() : d3.geoOrthographic().precision(0.1);
var graticule = d3.geoGraticule10();
var path = d3.geoPath(projection).context(context);
var v0; // Mouse position in Cartesian coordinates at start of drag gesture.
var r0; // Projection rotation as Euler angles at start.
var q0; // Projection rotation as versor at start.
var lastTime = d3.now();
var degPerMs = degPerSec / 1000;
var width, height;
var land, countries;
var countryList;
var autorotate, now, diff, rotation;
var currentCountry;

//
// Functions
//


function getSelectedCountry(country) {
  var country = countryList.find(function(c) {
    return c.id === country.id.toString();
  });

  return country || {};
}

function enter(country) {
  var country = getSelectedCountry(country);
  var countryName = country.name || "";
  current.text(countryName);
}

function leave(country) {
  current.text("");
}

function setAngles() {
  var rotation = projection.rotate()
  rotation[0] = angles.y
  rotation[1] = angles.x
  rotation[3] = angles.z
  projection.rotate(rotation)
}

function scale() {
  width = document.documentElement.clientWidth
  height = document.documentElement.clientHeight
  canvas.attr('width', width).attr('height', height)
  projection
    .scale((scaleFactor * Math.min(width, height)) / 2)
    .translate([width / 2, height / 2])
  render()
}

function startRotation(delay) {
  autorotate.restart(rotate, delay || 0)
}

function stopRotation() {
  autorotate.stop()
}

function dragstarted() {
  v0 = versor.cartesian(projection.invert(d3.mouse(this)))
  r0 = projection.rotate()
  q0 = versor(r0)
  stopRotation()
}

function dragged() {
  var v1 = versor.cartesian(projection.rotate(r0).invert(d3.mouse(this)))
  var q1 = versor.multiply(q0, versor.delta(v0, v1))
  var r1 = versor.rotation(q1)
  projection.rotate(r1)
  render()
}

function dragended() {
  startRotation(rotationDelay)
}

function render() {
  context.clearRect(0, 0, width, height);
  fill(water, colorWater);
  stroke(graticule, colorGraticule);
  fillCountryColor();
}

function renderTooltip(c) {
  var country = getSelectedCountry(c);

  d3.select("#Name").text(`Donations from ${countryColors[country.id].name}`);
  d3.select("#Name2").text(`Total Bits ${countryColors[country.id].totalBits}`);

  d3.select("#tooltip")
    .style("left", d3.event.pageX + 20 + "px")
    .style("top", d3.event.pageY - 80 + "px")
    .style("display", "block")
    .style("opacity", 0.8);
}

function fill(obj, color) {
  context.beginPath();
  path(obj);
  context.fillStyle = color;
  context.fill();
}

function fillCountryColor() {
  countries.features.forEach(function(c, i) {
    let color =
      countryColors[c.id] &&
      countryColors[c.id].color &&
      countryColors[c.id].totalBits !== 0
        ? countryColors[c.id].color
        : colorLand;
    context.fillStyle = color;
    context.beginPath();
    path(c);
    context.fill();
  });
}

function stroke(obj, color) {
  context.beginPath();
  path(obj);
  context.strokeStyle = color;
  context.stroke();
}

function rotate(elapsed) {
  now = d3.now();
  diff = now - lastTime;
  if (diff < elapsed) {
    rotation = projection.rotate();
    rotation[0] += diff * degPerMs;
    projection.rotate(rotation);
    render();
  }
  lastTime = now;
}

function loadData(cb) {
  d3.json(
    "https://raw.githubusercontent.com/KoGor/Map-Icons-Generator/master/data/world-110m.json",
    function(error, world) {
      if (error) throw error;
      d3.tsv(
        "https://raw.githubusercontent.com/KoGor/Maps.GeoInfo/master/world-country-names.tsv",
        function(error, countries) {
          if (error) throw error;
          cb(world, countries);
        }
      );
    }
  );
}

// https://github.com/d3/d3-polygon
function polygonContains(polygon, point) {
  var n = polygon.length;
  var p = polygon[n - 1];
  var x = point[0],
    y = point[1];
  var x0 = p[0],
    y0 = p[1];
  var x1, y1;
  var inside = false;
  for (var i = 0; i < n; ++i) {
    (p = polygon[i]), (x1 = p[0]), (y1 = p[1]);
    if (y1 > y !== y0 > y && x < ((x0 - x1) * (y - y1)) / (y0 - y1) + x1)
      inside = !inside;
    (x0 = x1), (y0 = y1);
  }
  return inside;
}

function mousemove() {
  var c = getCountry(this);

  if (!c) {
    if (currentCountry) {
      leave(currentCountry);
      currentCountry = undefined;
      render();
    }
    return;
  }
  if (c === currentCountry) {
    return;
  }

  currentCountry = c;
  render();
  renderTooltip(c);
  enter(c);
}

function getCountry(event) {
  var pos = projection.invert(d3.mouse(event));

  return countries.features.find(function(f) {
    return f.geometry.coordinates.find(function(c1) {
      return (
        polygonContains(c1, pos) ||
        c1.find(function(c2) {
          return polygonContains(c2, pos);
        })
      );
    });
  });
}

function renderMap() {
  if (mapType === "flat") {
    canvas.on("mousemove", mousemove);
  } else {
    setAngles();

    canvas
      .call(
        d3
          .drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended)
      )
      .on("mousemove", mousemove);
  }
}


twitch.onAuthorized(async function(auth) {
  // save our credentials
  const token = auth.token;

  twitch.rig.log("Authorized");

  try {
    twitch.rig.log("Authorized 1");

    const queryRequest = {
      method: "GET",
      headers: { Authorization: "Bearer " + token }
    };

    const response = await fetch(
      "https://twitchmapebs.azurewebsites.net/channel/countryDonations",
      queryRequest
    );

    const resJSON = await response.json();

    countryColors = Object.keys(countryColors).reduce(function(
      accumulator,
      hashKey
    ) {
      const countryColorHash = accumulator[hashKey];

      const countryFound = resJSON.find(
        country =>
          country.country_id.toString() === countryColorHash.countryColorId
      );

      countryColorHash.totalBits = 0;

      if (countryFound) {
        countryColorHash.totalBits = countryFound.country_total;
      }

      return accumulator;
    },
    countryColors);

    twitch.rig.log("DONE UPDATING COUNTRY COLOR, LOADING MAP DATA");

    loadData(function(world, cList) {
      land = topojson.feature(world, world.objects.land);
      countries = topojson.feature(world, world.objects.countries);
      countryList = cList;
      renderMap();
      scale();
      
      autorotate = d3.timer(rotate);

    });
  } catch (err) {
    twitch.rig.log("ERROR ", err);
  }
});
